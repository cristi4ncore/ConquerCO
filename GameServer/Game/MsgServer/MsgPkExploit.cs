using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace DeathWish.Game.MsgServer
{
    public unsafe partial class MsgBuilder
    {
        public static unsafe ServerSockets.Packet PkExploitCreate(this ServerSockets.Packet stream, Client.GameClient user, byte Page)
        {
            stream.InitWriter();


            try
            {

                Role.Instance.Associate.Member[] Members = user.Player.Associate.GetPkExplorerRank();

                const int max = 10;
                int offset = Page * max;
                int count = Math.Min(max, Math.Max(0, Members.Length - offset));

                stream.Write(Extensions.Time32.Now.Value);
                stream.Write(1);//type?
                stream.Write(Members.Length);
                stream.Write((uint)count);

                foreach (var member in Members)
                {
                    stream.Write(member.Name, 16);
                    stream.Write((uint)member.KillsCount);
                    stream.Write((uint)member.Timer);
                    stream.Write((uint)member.BattlePower);
                    stream.Write((uint)0);
                }
            }
            catch (Exception e) { MyConsole.WriteException(e); }


            stream.Finalize(GamePackets.PkExploit);
            return stream;
        }
    }

    public class MsgPkExploit
    {

        [PacketAttribute(GamePackets.PkExploit)]
        public unsafe static void HandlerPkExploit(Client.GameClient user, ServerSockets.Packet stream)
        {
            try
            {
                uint timer = stream.ReadUInt32();
                uint Typ = stream.ReadUInt32();
                byte Page = stream.ReadUInt8();

                user.Send(stream.PkExploitCreate(user, Page));
            }
            catch (Exception e) { MyConsole.WriteLine(e.ToString()); }
        }
    }
}
